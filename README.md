# TPS.Yakovleva

Telegram-бот для подсчёта метрик по видео.

Схема простая: пользователь пишет вопрос на русском → бот строит запрос к PostgreSQL → отвечает одним числом.

## Как устроено
- Данные лежат в PostgreSQL в двух таблицах: `videos` и `video_snapshots`.
- При старте база создаётся из `db/001_init.sql`.
- Если файла `data/videos.json` нет, он скачивается автоматически с Google Drive (ссылка из ТЗ).

## Распознавание естественного языка
Основной режим: распознавание делается через GigaChat (LLM) — модель возвращает JSON с intent и параметрами.
Потом SQL собирается кодом по шаблонам (так надёжнее для автопроверки).

Файлы:
- `bot/schema_prompt.py` — промпт + описание схемы
- `bot/llm_nlu.py` — запрос к GigaChat и разбор JSON
- `bot/query_builder.py` — сборка SQL по intent

Если ключа GigaChat нет или модель не ответила вовремя — включается запасной разбор по правилам (`bot/fallback_nlu.py`).
Это нужно, чтобы бот всегда отвечал и не зависал.

## Запуск (Docker)
1) Создай `.env` рядом с `.env.example` и заполни как минимум `BOT_TOKEN`.
2) Запусти:
```bash
docker compose up --build
```
3) Напиши боту в Telegram вопрос.

## Примеры вопросов
- Сколько всего видео есть в системе?
- Сколько видео у креатора с id 11111111-1111-1111-1111-111111111111 вышло с 1 ноября 2025 по 5 ноября 2025 включительно?
- Сколько видео набрало больше 100000 просмотров за всё время?
- На сколько просмотров в сумме выросли все видео 28 ноября 2025?
- Сколько разных видео получали новые просмотры 27 ноября 2025?
